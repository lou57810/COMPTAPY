{% extends 'base_head_to_create.html' %}
{% load static %}
{% block content %}

<head>
  {% csrf_token %}
        <script>
          function getCSRFToken() {
              let cookies = document.cookie.split(';');
              for (let cookie of cookies) {
                  let [name, value] = cookie.trim().split('=');
                  if (name === 'csrftoken') return value;
              }
              return '';
          }
        </script>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Comptapy</title>

        <link href='https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css' rel='stylesheet'>
        <!-- Font Awesome -->
<!--        <script src="https://kit.fontawesome.com/14273d579a.js" crossorigin="anonymous"></script>-->
        <link href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css' rel='stylesheet'>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

        <link rel="stylesheet" href="{% static 'css/main.scss' %}">


        <!--  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.min.css" /><!--<styles ou dist>-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/styles/ht-theme-main-dark-auto.min.css" />
        <link rel="stylesheet" href="{% static 'css/base.css' %}">

        <!--<script type='text/javascript' src=''></script>-->
        <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
        <script type='text/javascript' src='https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js'></script>
        <script type='text/javascript' src='https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js'></script>

</head>

<section class="py-5 bg-light">
    <div class="container">
      <section class="wrapper">
        <div class="form-box login">
          <h1>Ajout Compte</h1>
        <div class="input-box">
          <form id="compte-form">
              <label>Numéro : <input type="text" name="numero" required></label><br>
              <label>Nom : <input type="text" name="nom" required></label><br>
              <label>Type de compte :
                  <select name="type_compte" required>
                      <option value="actif">Actif</option>
                      <option value="passif">Passif</option>
                      <option value="charge">Charge</option>
                      <option value="produit">Produit</option>
                  </select>
              </label><br>
              <label>Origine :
                  <select name="origine">
                      <option value="pgc">PGC</option>
                      <option value="utilisateur">Utilisateur</option>
                  </select>
              </label><br>

              <button type="submit">Enregistrer</button>
          </form>
        </div>
    <p id="message"></p>
        </div>
          <script>
              const form = document.getElementById("compte-form");
              const message = document.getElementById("message");

              // Si tu passes ?id=401 dans l'URL, on préremplit pour modifier
              const urlParams = new URLSearchParams(window.location.search);
              const compteId = urlParams.get("id");

              if (compteId) {
                  document.getElementById("form-title").textContent = "Modifier le compte " + compteId;
                  fetch(`/api/comptes/${compteId}/`)
                      .then(response => response.json())
                      .then(data => {
                          for (const field in data) {
                              if (form.elements[field]) {
                                  form.elements[field].value = data[field];
                              }
                          }
                      });
              }

              form.addEventListener("submit", function (e) {
                  e.preventDefault();
                  const formData = new FormData(form);
                  const jsonData = Object.fromEntries(formData.entries());

                  const url = compteId ? `/api/comptes/${compteId}/` : "/api/comptes/";
                  const method = compteId ? "PUT" : "POST";

                  fetch(url, {
                      method: method,
                      headers: {
                          "Content-Type": "application/json",
                          "X-CSRFToken": getCSRFToken()
                      },
                      body: JSON.stringify(jsonData)
                  })
                  .then(response => {
                      if (!response.ok) throw new Error("Erreur réseau");
                      return response.json();
                  })
                  .then(data => {
                      message.textContent = compteId ? "Compte mis à jour ✅" : "Compte créé ✅";
                      form.reset();
                  })
                  .catch(error => {
                      console.error("Erreur :", error);
                      message.textContent = "Erreur lors de l’enregistrement ❌";
                  });
              });
          </script>
        </section>
      </div>
</section>


{% endblock content %}
