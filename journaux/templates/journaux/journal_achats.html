{% extends 'base.html' %}
{% block content %}
{% load static %}

<section class="py-5">
    <div class="container">
        <h1>Journal d'achats</h1>
            <div id="hot">
              <button id="validateBtn" class="btn btn-primary mt-3">Valider les écritures</button>
              <script>
                const container = document.getElementById('hot');
                const hot = new Handsontable(container, {
                  data: [],colHeaders: ['Date',  'Compte', 'nom', 'Libellé', 'Quantité', 'Taux', 'Débit', 'Crédit', 'Solde'],
                  columns: [
                    {type: 'date', dateFormat: 'DD/MM/YYYY'},
                    {type: 'text'},
                    {type: 'text'},
                    {type: 'text'},
                    {type: 'numeric'},
                    {type: 'numeric'},
                    {type: 'numeric'},
                    {type: 'numeric'},
                    {type: 'text'}
                  ],
                  width: '100%',
                  height: 'auto',
                  minSpareRows: 1,
                  // colHeaders: true,
                  rowHeaders: true,
                  colWidths: [80,100,150, 350, 80, 50, 150, 150, 120],
                  manualColumnResize: true,
                  autoWrapRow: true,
                  autoWrapCol: true,
                  licenseKey: 'non-commercial-and-evaluation'
                });

              document.getElementById('validateBtn').addEventListener('click', function () {
              const data = hot.getData();
              // Filtrer les lignes vides
              const filteredData = data.filter(row => row.some(cell => cell !== null && cell !== ''));
              fetch("{% url 'valider_journal_achats' %}", {
              method: 'POST',
              headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
              },
              body: JSON.stringify({ lignes: filteredData })
              })
              .then(response => {
              if (response.ok) {
                alert("Écritures validées avec succès !");
                // Optionnel : vider le tableau
                hot.loadData([]);
              } else {
                alert("Erreur lors de la validation !");
              }
              })
                .catch(error => {
                console.error('Erreur :', error);
                alert("Erreur lors de la validation !");
                });
              });
            </script>
        </div>
    </div>
</section>
{% endblock content %}

